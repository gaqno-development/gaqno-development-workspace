name: Branch & PR Validation

on:
  push:
    branches-ignore: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  validate-branch:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Check branch name
        run: |
          BRANCH="${{ github.ref_name }}"
          PREFIXED='^(feature|fix|refactor|docs|ci|chore)/(KAN|GAQNO)-[0-9]+'
          BUG_BRANCH='^GAQNO-[0-9]+$'
          if echo "$BRANCH" | grep -qE "$PREFIXED"; then
            echo "Branch name valid: $BRANCH"
          elif echo "$BRANCH" | grep -qE "$BUG_BRANCH"; then
            echo "Branch name valid (bug): $BRANCH"
          else
            echo "::error::Branch must match: (feature|fix|refactor|docs|ci|chore)/(KAN|GAQNO)-XX or GAQNO-XX for bugs"
            echo "Current branch: $BRANCH"
            echo "Examples: feature/GAQNO-47-name, GAQNO-1152"
            exit 1
          fi

  validate-pr-title:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Check PR title
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          if ! echo "$TITLE" | grep -qE '(KAN|GAQNO)-[0-9]+'; then
            echo "::error::PR title must include Jira key (e.g. GAQNO-46 or KAN-46)"
            echo "Current title: $TITLE"
            echo "Example: GAQNO-1152 DevOps fix"
            exit 1
          fi
          echo "PR title valid: $TITLE"
