name: Self Healing

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

jobs:
  heal:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Analyze failure
        run: |
          cursor agent run failure-analyzer \
            --workflow-id ${{ github.event.workflow_run.id }} \
            --out analysis.json

      - name: Check confidence
        id: confidence
        run: |
          CONF=$(jq '.confidence' analysis.json)
          echo "confidence=$CONF" >> $GITHUB_OUTPUT

      - name: Generate fix
        if: ${{ steps.confidence.outputs.confidence >= 70 }}
        run: |
          cursor agent run fix-generator \
            --analysis analysis.json

      - name: Stop if low confidence
        if: ${{ steps.confidence.outputs.confidence < 70 }}
        run: |
          echo "Low confidence â€” human required"
          exit 1
